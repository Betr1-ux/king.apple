<!DOCTYPE html>
<html lang="ar">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0"/>
<title>ğŸ Apple Game</title>
<style>
  body {
    margin: 0;
    font-family: Arial, sans-serif;
    background: #2a004a;
    color: #fff;
    display: flex;
    justify-content: center;
    align-items: center;
    min-height: 100vh;
  }
  .card {
    text-align: center;
    background: #4a006e;
    padding: 25px;
    border-radius: 14px;
    box-shadow: 0 0 20px rgba(255,102,204,0.4);
    width: min(95vw, 420px);
    position: relative;
  }
  h1 { color: #ff66cc; font-size: 28px; margin-bottom: 15px; }
  .input {
    width: 100%; height: 44px; border: none; border-radius: 10px;
    margin: 6px 0; padding: 0 10px; text-align: center; font-size: 16px;
  }
  .error { display: none; color: #ff4b4b; font-weight: 700; margin: 6px 0; }
  button {
    padding: 12px 24px; border: none; border-radius: 10px;
    background: #ff66cc; color: #fff; font-size: 16px;
    cursor: pointer; font-weight: bold;
  }
  button:hover { opacity: .9; }
  .badge {
    background: #6a008f; padding: 8px 14px; border-radius: 10px;
    margin: 10px auto; display: inline-block;
  }
  .row { display: flex; align-items: center; justify-content: center; margin: 10px 0; gap: 10px; }
  .mult { background: #ff66cc; padding: 8px; border-radius: 8px; font-weight: bold; min-width: 70px; }
  .slots { display: flex; gap: 10px; }
  .slot {
    width: 46px; height: 46px; background: #fff; border-radius: 8px;
    font-size: 26px; display: flex; align-items: center; justify-content: center; color: #000;
  }
  .loader {
    border: 6px solid #fff; border-top: 6px solid #ff66cc;
    border-radius: 50%; width: 60px; height: 60px;
    animation: spin 1s linear infinite;
    margin: 20px auto; display: none;
  }
  @keyframes spin { 0%{transform:rotate(0)}100%{transform:rotate(360deg)} }

  /* Ø²Ø± Ø§Ù„ØªÙˆØ¬ÙŠÙ‡ Ù„Ù„ØªÙŠÙ„ÙŠØ¬Ø±Ø§Ù… */
  .telegram-btn {
    position: absolute;
    bottom: -60px;
    left: 50%;
    transform: translateX(-50%);
    background: #0088cc;
    border-radius: 50%;
    width: 56px;
    height: 56px;
    display: flex;
    align-items: center;
    justify-content: center;
    box-shadow: 0 0 15px rgba(0,136,204,0.6);
    cursor: pointer;
    transition: 0.3s;
  }
  .telegram-btn:hover { background: #00aaff; }
  .telegram-btn img {
    width: 28px; height: 28px;
  }
</style>
</head>
<body>

<!-- ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„ -->
<div id="loginBox" class="card">
  <h1>ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„</h1>
  <input id="userId" class="input" type="text" placeholder="ID" />
  <input id="code" class="input" type="text" placeholder="Code" autocomplete="one-time-code" />
  <div id="errorMsg" class="error">ÙƒÙˆØ¯ Ø®Ø·Ø£ Ø£Ùˆ Ø§Ù†ØªÙ‡Ù‰</div>
  <button onclick="login()">ØªØ£ÙƒÙŠØ¯</button>

  <!-- Ø²Ø± Ø§Ù„ØªÙŠÙ„ÙŠØ¬Ø±Ø§Ù… -->
  <a href="https://t.me/Loty122" target="_blank" class="telegram-btn">
    <img src="https://upload.wikimedia.org/wikipedia/commons/8/82/Telegram_logo.svg" alt="Telegram"/>
  </a>
</div>

<!-- ÙˆØ§Ø¬Ù‡Ø© Ø§Ù„Ù„Ø¹Ø¨Ø© -->
<div id="gameBox" class="card" style="display:none;">
  <h1>ğŸ Apple Game</h1>
  <div class="badge">Ø§Ù„Ù…Ø­Ø§ÙˆÙ„Ø§Øª: <b id="attempts">0</b></div>

  <div class="row">
    <div class="mult">X4.02</div>
    <div class="slots"><div class="slot"></div><div class="slot"></div><div class="slot"></div><div class="slot"></div><div class="slot"></div></div>
  </div>
  <div class="row">
    <div class="mult">X2.41</div>
    <div class="slots"><div class="slot"></div><div class="slot"></div><div class="slot"></div><div class="slot"></div><div class="slot"></div></div>
  </div>
  <div class="row">
    <div class="mult">X1.93</div>
    <div class="slots"><div class="slot"></div><div class="slot"></div><div class="slot"></div><div class="slot"></div><div class="slot"></div></div>
  </div>
  <div class="row">
    <div class="mult">X1.54</div>
    <div class="slots"><div class="slot"></div><div class="slot"></div><div class="slot"></div><div class="slot"></div><div class="slot"></div></div>
  </div>
  <div class="row">
    <div class="mult">X1.23</div>
    <div class="slots"><div class="slot"></div><div class="slot"></div><div class="slot"></div><div class="slot"></div><div class="slot"></div></div>
  </div>

  <div class="loader" id="loader"></div>

  <div style="margin-top:20px;display:flex;gap:15px;justify-content:center;">
    <button onclick="startShowApples()">Show Apple</button>
    <button onclick="resetGame()">Reset Game</button>
  </div>
</div>

<script type="module">
  import { initializeApp } from "https://www.gstatic.com/firebasejs/9.22.2/firebase-app.js";
  import { getDatabase, ref, get, update } from "https://www.gstatic.com/firebasejs/9.22.2/firebase-database.js";

  const firebaseConfig = {
    apiKey: "AIzaSyAF1K59iKFsVH-wyAKyGw2wsIMUIØ±T9WMg",
    authDomain: "admin-3fd30.firebaseapp.com",
    databaseURL: "https://admin-3fd30-default-rtdb.firebaseio.com",
    projectId: "admin-3fd30",
    storageBucket: "admin-3fd30.firebasestorage.app",
    messagingSenderId: "981773176798",
    appId: "1:981773176798:web:1ebc106e60af04ed8a174f",
    measurementId: "G-35L6036ED8"
  };

  const app = initializeApp(firebaseConfig);
  const db = getDatabase(app);

  let attempts = 0;
  let currentCode = "";

  window.login = async () => {
    const userId = document.getElementById("userId").value.trim();
    const codeInput = document.getElementById("code").value.trim();
    const errorMsg = document.getElementById("errorMsg");

    if (!userId || !codeInput) {
      errorMsg.style.display = "block";
      errorMsg.textContent = "ID Ø§Ø¯Ø®Ù„ Ø§Ù„ÙƒÙˆØ¯ Ùˆ";
      return;
    }

    try {
      const snap = await get(ref(db, "codes/" + codeInput));
      if (!snap.exists()) throw new Error("invalid");

      const data = snap.val();
      if ((data.remaining ?? 0) <= 0) throw new Error("exhausted");

      currentCode = codeInput;
      attempts = data.remaining;
      await update(ref(db, "codes/" + codeInput), { user: userId });

      errorMsg.style.display = "none";
      document.getElementById("loginBox").style.display = "none";
      document.getElementById("gameBox").style.display = "block";
      updateAttemptsUI();
    } catch(e){
      errorMsg.style.display = "block";
      errorMsg.textContent = "ÙƒÙˆØ¯ Ø®Ø·Ø£ Ø£Ùˆ Ø§Ù†ØªÙ‡Ù‰";
    }
  };

  function updateAttemptsUI(){
    document.getElementById("attempts").textContent = attempts;
  }

  function logoutAuto(){
    document.getElementById("gameBox").style.display = "none";
    document.getElementById("loginBox").style.display = "block";
    document.querySelectorAll('.slot').forEach(s => s.textContent = "");
    document.getElementById("loader").style.display = "none";
    currentCode = "";
  }

  window.startShowApples = async () => {
    if (attempts <= 0) {
      logoutAuto();
      return;
    }
    attempts--;
    updateAttemptsUI();
    await update(ref(db, "codes/" + currentCode), { remaining: attempts });

    document.getElementById("loader").style.display = "block";
    document.querySelectorAll('.slot').forEach(s => s.textContent = "");

    setTimeout(() => {
      document.getElementById("loader").style.display = "none";
      showApples();

      if (attempts <= 0) {
        setTimeout(()=> logoutAuto(), 1000);
      }
    }, 2000);
  };

  function showApples() {
    document.querySelectorAll('.row').forEach(row => {
      let slots = row.querySelectorAll('.slot');
      let randomIndex = Math.floor(Math.random() * slots.length);
      slots[randomIndex].textContent = "ğŸ";
    });
  }

  window.resetGame = () => {
    document.querySelectorAll('.slot').forEach(s => s.textContent = "");
    document.getElementById("loader").style.display = "none";
  };
</script>
</body>
</html>
